Description: Fix double free in SLPDProcessMessage() (CVE-2015-5177)
Origin: http://sourceforge.net/p/openslp/mercurial/ci/2bc15d0494f886d9c4fe342d23bc160605aea51d/
Bug-Debian: https://bugs.debian.org/795429
Author: Santiago Ruano Rinc√≥n <santiagorr@riseup.net>
Reviewed-by: Alessandro Ghedini <ghedo@debian.org>
Last-Update: 2015-09-04

diff --git a/slpd/slpd_knownda.c b/slpd/slpd_knownda.c
index 0c0bddc..0338a63 100644
--- a/slpd/slpd_knownda.c
+++ b/slpd/slpd_knownda.c
@@ -823,15 +823,15 @@ int SLPDKnownDAAdd(SLPMessage msg, SLPBuffer buf)
              */
             SLPDLogDAAdvertisement("Removed",entry);
         }
+        /* If we are here, we need to cleanup the message descriptor and the  */
+        /* message buffer because they were not added to the database and not */
+        /* cleaning them up would result in a memory leak                     */
+        /* We also need to make sure the Database handle is closed.           */
+        SLPMessageFree(msg);
+        SLPBufferFree(buf);
     }
 
     CLEANUP:
-    /* If we are here, we need to cleanup the message descriptor and the  */
-    /* message buffer because they were not added to the database and not */
-    /* cleaning them up would result in a memory leak                     */
-    /* We also need to make sure the Database handle is closed.           */
-    SLPMessageFree(msg);
-    SLPBufferFree(buf);
     if (dh) SLPDatabaseClose(dh);
 
     return result;
